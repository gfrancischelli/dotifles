var mongoose = require('mongoose');
var User = mongoose.model('User');


exports.index = function(req, res) {
    const session = req.session;

    if (session.loggedIn === true ) {
        res.render('user-page', {
            title: session.user.name,
            name: session.user.name,
            email: session.user.email,
            userID: session.user._id,
        });
    }
    else {
        res.redirect('/login');
    }
}

exports.create = function(req, res) { 
    console.log('create');
    res.render('user-form', {
        title: 'Create User',
        _id: ' ',
        name: " ",
        email: " ",
        buttonText: "Join!",
    });
};

exports.edit = function(req, res) { 
    if (req.session.loggedIn !== true) {
        res.redirect('/login');
    }
    else {
        res.render('user-form', {
            title: 'Edit User',
            _id: req.session.user._id,
            name: req.session.user.name,
            email: req.session.user.email,
            buttonText: "Join!",
        });
    }
};

exports.doEdit = function(req, res) {
    console.log('doEdit')    
    if (req.session.loggedIn === true) {
        console.log('logged in');
        User.findById(req.session.user._id,
            function(err, user) {
                if(err) { res.redirect('/user?error=finding')}
                else {
                    if(!err) {
                        user.name = req.body.FullName;
                        user.email = req.body.Email;
                        user.modifiedOn = Date.now();
                        user.save(function(err) {
                            console.log(`User updated: ${req.body.FullName}`);
                            req.session.user.name = req.body.FullName;
                            req.session.user.email = req.body.Email;
                            res.redirect('/user');
                        });
                    }
                }
            });
    }
    else { res.redirect('/login')}
}

exports.doCreate = function(req, res) {
    const name = req.body.FullName;
    const email = req.body.Email;

    User.create({
        name: name,
        email: email,
        modifiedOn: Date.now(),
        lastLogin: Date.now(),
    }, function(err, user) {
        // Error
        if(err) {
            console.log(err);
            if(err.code == 11000) {
                res.redirect( '/user/new?exists=true' );
            } else {
                res.redirect( '/?error=true');
            };
        } 
        // Success 
        else {
            console.log(`User created and saved: ${user}`);
            req.session.user = {
                "name": user.name, "email": user.email, "_id": user.id
            };
            req.session.loggedIn = true;
            console.log(`Logged in user: ${user}`)
            User.update(
                { _id: user.id },
                { $set: { lastLogin: Date.now()} },
                function() {
                    res.redirect('/user');
                }
            );
        };
    });
};

exports.login = function(req, res) {
    res.render('login-form', {title: 'Log In'});
}

exports.dologin = function(req, res) {
    if( req.body.Email ) {
        User.findOne(
            {email: req.body.Email },
            '_id name email'
        )
        .exec(function(err, user) {
            if (!err) {
                if( !user ) {
                    res.redirect('/login?404=user');
                }
                else {
                    req.session.user = {
                        "name": user.name,
                        "email": user.email,
                        "_id": user.id,
                    };
                    req.session.loggedIn = true;
                    console.log(`Logged in user: ${user}`);
                    res.redirect( '/user' );
                }
            }
            else {
                res.redirect('/login?404=error');
            } 
        });
    }
    else {
        res.redirect('/login?404=error')
    }
}


exports.confirmDelete = function(req, res) {
    res.render('user-delete-form', {
        title: 'Delete Account',
        _id: req.session.user._id,
        name: req.session.user.name,
        email: req.session.user.email
    });
}

exports.doDelete = function(req, res) {
    if (req.body._id) {
        User.findByIdAndRemove(
            req.body.id,
            function(err, user) {
                if(err) {
                    console.log(err);
                    return res.redirect('/user?error=deleting');
                }
                console.log(`User deleted: ${user}`);
                clearSession(req.session, function() {
                    res.redirect('/');
                });
            }
        );
    }
}
